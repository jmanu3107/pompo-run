<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Viewport ajustado para iPhone para evitar zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pompo Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Intentamos cargar la fuente Arcade si hay internet */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            /* CAMBIO CLAVE: Si falla 'Press Start 2P', usa 'Courier New' o 'monospace' */
            /* Esto evita que salga la letra cursiva en iPhone */
            font-family: 'Press Start 2P', 'Courier New', Courier, monospace; 
            background-color: #202124;
            color: #535353;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            margin: 0;
            padding: 0;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #202124;
        }

        canvas {
            border-bottom: 2px solid #535353;
            background-color: transparent;
            max-width: 100%;
        }

        .ui-layer {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -30%);
            text-align: center;
            z-index: 20;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #eee;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .hidden {
            display: none !important;
        }

        .btn {
            background-color: #535353;
            border: 2px solid #333;
            padding: 15px 30px;
            /* Aplicamos la misma regla de fuente a los botones */
            font-family: 'Press Start 2P', 'Courier New', Courier, monospace;
            font-size: 16px;
            cursor: pointer;
            color: #fff;
            margin-top: 15px;
            border-radius: 4px;
            width: 100%;
            touch-action: manipulation;
            font-weight: bold; /* Negrita para que se vea más pixelada en monospace */
        }

        .btn:active {
            transform: scale(0.95);
            opacity: 0.9;
        }

        #score-board {
            position: absolute;
            top: 40px;
            right: 20px;
            font-size: 16px;
            color: #acacac;
            font-weight: bold;
        }
        
        #controls-hint {
            position: absolute;
            bottom: 20px;
            color: #757575;
            font-size: 10px;
            text-align: center;
            width: 100%;
            pointer-events: none;
            opacity: 0.7;
            font-weight: bold;
        }

        #mobile-controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 40px;
            pointer-events: none;
            z-index: 15;
        }
        
        .control-btn {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #535353;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #535353;
            user-select: none;
            backdrop-filter: blur(2px);
        }
        
        .control-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="score-board">HI 00000 00000</div>

        <canvas id="gameCanvas"></canvas>

        <!-- UI Overlay -->
        <div id="start-screen" class="ui-layer">
            <h1 class="text-xl mb-2 text-gray-600 font-bold">POMPO RUN</h1>
            
            <!-- Mini preview -->
            <div class="flex flex-col items-center mb-4">
                <img id="preview-img" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #535353; object-fit: cover;">
            </div>
            
            <button id="start-btn" class="btn">JUGAR</button>
        </div>

        <div id="game-over-screen" class="ui-layer hidden">
            <h1 class="text-xl mb-4 text-gray-600 font-bold">GAME OVER</h1>
            <button id="restart-btn" class="btn">REINTENTAR</button>
        </div>
        
        <div id="mobile-controls">
            <div id="duck-btn" class="control-btn">⬇️</div>
            <div id="jump-btn" class="control-btn" style="margin-left: auto;">⬆️</div>
        </div>

        <div id="controls-hint">PC: Espacio / Móvil: Botones</div>
    </div>

    <script>
        // Imagen por defecto (Perrito Pixel Art ligero)
        const defaultPompoBase64 = "data:image/png;base64,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";

        // --- GAME VARIABLES ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const scoreBoard = document.getElementById('score-board');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const jumpBtn = document.getElementById('jump-btn');
        const duckBtn = document.getElementById('duck-btn');
        const previewImg = document.getElementById('preview-img');

        let GAME_SPEED = 6; 
        const GRAVITY = 0.6;
        const JUMP_FORCE = -12;
        const GROUND_HEIGHT = 20;
        let isPlaying = false;
        let score = 0;
        let highScore = 0;
        let frame = 0;
        let speedMultiplier = 1;

        // --- IMAGE HANDLING ---
        const pompoImg = new Image();
        let currentImageSrc = defaultPompoBase64; 

        // Chequear si ya tenemos una imagen guardada en localStorage (opcional)
        try {
            const stored = localStorage.getItem('myPompoImg');
            if(stored) currentImageSrc = stored;
        } catch(e) {}

        pompoImg.src = currentImageSrc;
        previewImg.src = currentImageSrc;

        pompoImg.onload = function() {
            resize();
            // CORRECCIÓN: Establecer la posición Y correcta INMEDIATAMENTE al cargar la imagen
            // Esto evita que se dibuje en (0,0) antes de saber dónde está el suelo
            player.y = canvas.height - GROUND_HEIGHT - 51; 
            
            if(!isPlaying) {
                drawScene();
                player.draw();
            }
        };

        // --- GAME ENGINE ---
        function resize() {
            canvas.width = Math.min(window.innerWidth, 800);
            canvas.height = 300;
        }
        window.addEventListener('resize', resize);

        const player = {
            x: 50, y: 0, width: 44, height: 47,
            crouchHeight: 25, crouchWidth: 55,
            dy: 0, grounded: false, crouching: false,
            draw: function() {
                const isCrouching = this.crouching && this.grounded;
                const headSize = 35;
                ctx.fillStyle = "#535353";
                
                if (isCrouching) {
                    ctx.fillRect(this.x, this.y + 15, 40, 15);
                    if (Math.floor(frame / 5) % 2 === 0) {
                        ctx.fillRect(this.x + 10, this.y + 30, 8, 4);
                        ctx.fillRect(this.x + 25, this.y + 30, 8, 4);
                    } else {
                        ctx.fillRect(this.x + 8, this.y + 30, 8, 4);
                        ctx.fillRect(this.x + 28, this.y + 30, 8, 4);
                    }
                    this.drawHead(this.x + 25, this.y + 5, headSize);
                } else {
                    ctx.fillRect(this.x, this.y + 15, 30, 25);
                    ctx.fillRect(this.x - 10, this.y + 20, 10, 15);
                    ctx.fillRect(this.x - 15, this.y + 25, 5, 5);
                    ctx.fillRect(this.x + 28, this.y + 20, 8, 4);
                    if (this.grounded) {
                        if (Math.floor(frame / 5) % 2 === 0) {
                            ctx.fillRect(this.x + 5, this.y + 40, 6, 8);
                            ctx.fillRect(this.x + 5, this.y + 48, 8, 3);
                            ctx.fillRect(this.x + 20, this.y + 40, 6, 4);
                        } else {
                            ctx.fillRect(this.x + 5, this.y + 40, 6, 4);
                            ctx.fillRect(this.x + 20, this.y + 40, 6, 8);
                            ctx.fillRect(this.x + 20, this.y + 48, 8, 3);
                        }
                    } else {
                        ctx.fillRect(this.x + 5, this.y + 38, 6, 8);
                        ctx.fillRect(this.x + 20, this.y + 40, 6, 6);
                    }
                    this.drawHead(this.x + 15, this.y - 5, headSize);
                }
            },
            drawHead: function(x, y, size) {
                if (pompoImg.complete) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(x + size/2, y + size/2, size/2, 0, Math.PI * 2);
                    ctx.closePath();
                    ctx.clip();
                    ctx.drawImage(pompoImg, x, y, size, size);
                    ctx.restore();
                } else {
                    ctx.fillStyle = "#999";
                    ctx.fillRect(x, y, size, size);
                }
            },
            update: function() {
                if (keys['ArrowDown'] || keys['DuckBtn']) this.crouching = true;
                else this.crouching = false;
                
                if ((keys['Space'] || keys['ArrowUp'] || keys['JumpBtn']) && !this.crouching) this.jump();
                
                this.y += this.dy;
                const footLevel = canvas.height - GROUND_HEIGHT;
                const visualHeight = this.crouching ? 34 : 51;
                
                if (this.y + visualHeight < footLevel) {
                    this.dy += GRAVITY;
                    if (this.crouching) this.dy += 0.5;
                    this.grounded = false;
                } else {
                    this.dy = 0;
                    this.grounded = true;
                    this.y = footLevel - visualHeight;
                }
            },
            jump: function() {
                if (this.grounded) {
                    this.dy = JUMP_FORCE;
                    this.grounded = false;
                }
            }
        };

        // Obstacles
        let obstacles = [];
        class Obstacle {
            constructor() {
                this.x = canvas.width;
                this.markedForDeletion = false;
                const allowBird = score > 400;
                const rand = Math.random();
                if (allowBird && rand > 0.75) {
                    this.type = 'BIRD';
                    this.w = 42; this.h = 30;
                    const heights = [20, 50, 75];
                    this.yOffset = heights[Math.floor(Math.random() * heights.length)];
                    this.y = canvas.height - GROUND_HEIGHT - this.yOffset;
                } else {
                    if (Math.random() > 0.5) {
                        this.type = 'CACTUS_LARGE'; this.w = 25; this.h = 48;
                    } else {
                        this.type = 'CACTUS_SMALL'; this.w = 17; this.h = 34;
                    }
                    this.y = canvas.height - GROUND_HEIGHT - this.h;
                    this.count = Math.random() > 0.6 ? 2 : 1;
                    if (Math.random() > 0.8 && this.type === 'CACTUS_SMALL') this.count = 3;
                    this.totalW = this.w + (this.count - 1) * (this.w/2 + 5);
                }
            }
            update() {
                this.x -= GAME_SPEED * speedMultiplier;
                if (this.x + (this.totalW || this.w) < 0) this.markedForDeletion = true;
            }
            draw() {
                ctx.fillStyle = "#535353";
                if (this.type === 'BIRD') {
                    const wingState = Math.floor(frame / 10) % 2;
                    ctx.fillRect(this.x + 10, this.y + 10, 20, 8);
                    ctx.fillRect(this.x, this.y + 5, 12, 10);
                    ctx.fillRect(this.x - 5, this.y + 8, 5, 4);
                    if (wingState === 0) {
                        ctx.fillRect(this.x + 15, this.y - 5, 8, 15);
                        ctx.fillRect(this.x + 23, this.y - 10, 8, 10);
                    } else {
                        ctx.fillRect(this.x + 15, this.y + 10, 8, 10);
                        ctx.fillRect(this.x + 23, this.y + 15, 8, 8);
                    }
                } else {
                    for (let i = 0; i < this.count; i++) {
                        let cx = this.x + i * (this.w + 2);
                        ctx.fillRect(cx, this.y, this.w, this.h);
                        ctx.fillStyle = "#aaaaaa";
                        ctx.fillRect(cx + 4, this.y + 4, 2, this.h - 10);
                        ctx.fillStyle = "#535353";
                        if (this.type === 'CACTUS_LARGE') {
                            ctx.fillRect(cx - 5, this.y + 15, 5, 15);
                            ctx.fillRect(cx + this.w, this.y + 10, 5, 15);
                        } else {
                            ctx.fillRect(cx - 4, this.y + 10, 4, 10);
                            ctx.fillRect(cx + this.w, this.y + 8, 4, 10);
                        }
                    }
                }
            }
            getHitbox() {
                if (this.type === 'BIRD') return { x: this.x, y: this.y + 5, w: this.w, h: this.h - 10 };
                return { x: this.x, y: this.y, w: this.totalW || this.w, h: this.h };
            }
        }

        // Inputs
        const keys = {};
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') keys['Space'] = true;
            if (e.code === 'ArrowDown') keys['ArrowDown'] = true;
        });
        window.addEventListener('keyup', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') keys['Space'] = false;
            if (e.code === 'ArrowDown') keys['ArrowDown'] = false;
        });
        function bindBtn(elem, keyName) {
            elem.addEventListener('mousedown', (e) => { e.preventDefault(); keys[keyName] = true; });
            elem.addEventListener('mouseup', (e) => { e.preventDefault(); keys[keyName] = false; });
            elem.addEventListener('touchstart', (e) => { e.preventDefault(); keys[keyName] = true; });
            elem.addEventListener('touchend', (e) => { e.preventDefault(); keys[keyName] = false; });
        }
        bindBtn(jumpBtn, 'JumpBtn');
        bindBtn(duckBtn, 'DuckBtn');
        canvas.addEventListener('touchstart', (e) => {
            if (!isPlaying) {
                if (!startScreen.classList.contains('hidden')) startGame();
                else if (!gameOverScreen.classList.contains('hidden')) resetGame();
            }
        });

        // Loop
        function animate() {
            if (!isPlaying) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Ground
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - GROUND_HEIGHT);
            ctx.lineTo(canvas.width, canvas.height - GROUND_HEIGHT);
            ctx.strokeStyle = "#535353"; ctx.lineWidth = 2; ctx.stroke();

            // Spawn
            let spawnRate = Math.floor(100 / speedMultiplier);
            if (spawnRate < 40) spawnRate = 40;
            if (frame % spawnRate === 0 && Math.random() > 0.3) obstacles.push(new Obstacle());

            // Update
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.update();
                obs.draw();
                
                // Collision
                let pW = player.crouching && player.grounded ? player.crouchWidth : player.width;
                let pH = player.crouching && player.grounded ? player.crouchHeight : player.height;
                let pY = player.y + (player.crouching && player.grounded ? 15 : 0);
                let oBox = obs.getHitbox();
                const pad = 6;
                
                if (player.x + pad < oBox.x + oBox.w - pad &&
                    player.x + pW - pad > oBox.x + pad &&
                    pY + pad < oBox.y + oBox.h - pad &&
                    pY + pH - pad > oBox.y + pad) {
                    gameOver();
                }
                if (obs.markedForDeletion) obstacles.splice(i, 1);
            }

            player.update();
            player.draw();
            score++; frame++;
            if (score % 500 === 0) speedMultiplier += 0.1;
            
            // Score
            const scoreStr = score.toString().padStart(5, '0');
            const highStr = highScore.toString().padStart(5, '0');
            scoreBoard.innerText = `HI ${highStr} ${scoreStr}`;
            
            requestAnimationFrame(animate);
        }

        function startGame() {
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            document.getElementById('mobile-controls').style.display = 'flex';
            isPlaying = true; score = 0; frame = 0; speedMultiplier = 1; obstacles = [];
            player.y = canvas.height - GROUND_HEIGHT - player.height;
            animate();
        }
        function gameOver() {
            isPlaying = false;
            if (score > highScore) highScore = score;
            gameOverScreen.classList.remove('hidden');
        }
        function resetGame() { startGame(); }

        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', resetGame);

        resize();
        // Init render
        setTimeout(() => {
            // Reordered to fix disappearing Pompo on initial load
            player.y = canvas.height - GROUND_HEIGHT - 51;
            drawScene(); 
            player.draw();
        }, 100);
        
        // Helper to draw ground/scene for static screens
        function drawScene() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - GROUND_HEIGHT);
            ctx.lineTo(canvas.width, canvas.height - GROUND_HEIGHT);
            ctx.strokeStyle = "#535353"; ctx.lineWidth = 2; ctx.stroke();
        }

    </script>
</body>
</html>